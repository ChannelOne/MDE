"use strict";
const vElement_1 = require("./vElement");
const list_diff2_1 = require("list-diff2");
(function (DiffType) {
    DiffType[DiffType["REPLACE"] = 0] = "REPLACE";
    DiffType[DiffType["REORDER"] = 1] = "REORDER";
    DiffType[DiffType["PROPS"] = 2] = "PROPS";
    DiffType[DiffType["TEXT"] = 3] = "TEXT";
})(exports.DiffType || (exports.DiffType = {}));
var DiffType = exports.DiffType;
function diff(oldTree, newTree) {
    let index = 0;
    let patches = new Map();
    dfsWalk(oldTree, newTree, index, patches);
    return patches;
}
exports.diff = diff;
function dfsWalk(oldNode, newNode, index, patches) {
    let currentPatch = [];
    if (newNode === null) {
    }
    else if (typeof oldNode == "string" && typeof newNode == "string") {
        if (newNode !== oldNode) {
            currentPatch.push({
                type: DiffType.TEXT,
                content: newNode,
            });
        }
    }
    else if ((oldNode instanceof vElement_1.VElement && newNode instanceof vElement_1.VElement) &&
        oldNode.tagName === newNode.tagName) {
        let propsPatches = diffProps(oldNode, newNode);
        if (propsPatches !== null)
            if (Object.keys(propsPatches).length > 0)
                currentPatch.push({
                    type: DiffType.PROPS,
                    props: propsPatches,
                });
        diffChildren(oldNode.children, newNode.children, index, patches, currentPatch);
    }
    else {
        patches[index].push({
            type: DiffType.REPLACE,
            node: newNode,
        });
    }
    if (currentPatch.length > 0)
        patches[index] = currentPatch;
}
function diffChildren(oldChildren, newChildren, index, patches, currentPatch) {
    let diffs = list_diff2_1.listDiff(oldChildren, newChildren, "key");
    newChildren = diffs.children;
    if (diffs.moves.length > 0) {
        let reorderPatch = {
            type: DiffType.REORDER,
            moves: diffs.moves
        };
        currentPatch.push(reorderPatch);
    }
    let leftNode = null;
    let currentNodeIndex = index;
    oldChildren.forEach((child, i) => {
        let newChild = newChildren[i];
        currentNodeIndex = (leftNode && leftNode.count)
            ? currentNodeIndex + leftNode.count + 1
            : currentNodeIndex + 1;
        dfsWalk(child, newChild, currentNodeIndex, patches);
        leftNode = child;
    });
}
function diffProps(oldNode, newNode) {
    let count = 0;
    let oldProps = oldNode.props;
    let newProps = newNode.props;
    let key, value;
    let propsPatches = new Map();
    for (key in oldProps) {
        value = oldProps[key];
        if (newProps[key] !== value) {
            count++;
            propsPatches[key] = newProps[key];
        }
    }
    for (key in newProps) {
        value = newProps[key];
        if (!oldProps.has(key)) {
            count++;
            propsPatches[key] = newProps[key];
        }
    }
    if (count === 0)
        return null;
    return propsPatches;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy92aXJ0dWFsRE9NL2RpZmYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUlBLDJCQUF1QixZQUN2QixDQUFDLENBRGtDO0FBQ25DLDZCQUF1QixZQUV2QixDQUFDLENBRmtDO0FBRW5DLFdBQVksUUFBUTtJQUNoQiw2Q0FBTyxDQUFBO0lBQ1AsNkNBQU8sQ0FBQTtJQUNQLHlDQUFLLENBQUE7SUFDTCx1Q0FBSSxDQUFBO0FBQ1IsQ0FBQyxFQUxXLGdCQUFRLEtBQVIsZ0JBQVEsUUFLbkI7QUFMRCxJQUFZLFFBQVEsR0FBUixnQkFLWCxDQUFBO0FBU0QsY0FBcUIsT0FBa0IsRUFBRSxPQUFrQjtJQUN2RCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDZCxJQUFJLE9BQU8sR0FBOEIsSUFBSSxHQUFHLEVBQXdCLENBQUM7SUFDekUsT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7QUFDbkIsQ0FBQztBQUxlLFlBQUksT0FLbkIsQ0FBQTtBQUVELGlCQUFpQixPQUEwQixFQUFFLE9BQTBCLEVBQ25FLEtBQWEsRUFBRSxPQUFrQztJQUVqRCxJQUFJLFlBQVksR0FBaUIsRUFBRSxDQUFDO0lBR3BDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBRXZCLENBQUM7SUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxPQUFPLElBQUksUUFBUSxJQUFJLE9BQU8sT0FBTyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDbEUsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDdEIsWUFBWSxDQUFDLElBQUksQ0FBQztnQkFDZCxJQUFJLEVBQUUsUUFBUSxDQUFDLElBQUk7Z0JBQ25CLE9BQU8sRUFBRSxPQUFPO2FBQ25CLENBQUMsQ0FBQTtRQUNOLENBQUM7SUFD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O1FBQ25CLEtBQUssR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDMUIsS0FBSyxFQUFFLENBQUM7WUFDUixZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLENBQUM7SUFDTCxDQUFDO0lBRUQsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDbkIsS0FBSyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QixFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLEtBQUssRUFBRSxDQUFDO1lBQ1IsWUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QyxDQUFDO0lBQ0wsQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUM7UUFDWixNQUFNLENBQUMsSUFBSSxDQUFDO0lBRWhCLE1BQU0sQ0FBQyxZQUFZLENBQUM7QUFDeEIsQ0FBQyIsImZpbGUiOiJ2aXJ0dWFsRE9NL2RpZmYuanMiLCJzb3VyY2VSb290Ijoic3JjLyJ9
